<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Export Survey Data</title>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f0f8fa;
      color: #2A6972;
      padding: 2em;
      max-width: 600px;
      margin: auto;
    }
    button {
      background-color: #2A6972;
      color: white;
      font-size: 1.1em;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 1em;
    }
    button:hover {
      background-color: #24545a;
    }
  </style>
</head>
<body>
  <h1>Export Wellness Data</h1>
  <p>Click the button below to download all survey responses as a CSV file.</p>
  <button onclick="downloadCSV()">Download CSV</button>

  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3_c5ZI9fPnN6Jjlw6tneKjs5Hjq-epMw",
      authDomain: "pinnacle-wellness-assessment.firebaseapp.com",
      projectId: "pinnacle-wellness-assessment"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function downloadCSV() {
      const snapshot = await db.collection("surveyResponses").get();
      const rows = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const row = {
          timestamp: data.timestamp?.toDate().toISOString() || '',
          email: data.email || '',
          subscribeNewsletter: data.subscribeNewsletter || false,
          totalScore: data.totalScore || 0,
          ...data.domainScores
        };
        rows.push(row);
      });

      if (!rows.length) {
        alert("No data to export.");
        return;
      }

      const headers = Object.keys(rows[0]);
      const csv = [
        headers.join(","),
        ...rows.map(row => headers.map(h => `"${(row[h] ?? '').toString().replace(/"/g, '""')}"`).join(","))
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "wellness_data.csv";
      a.click();
    }
  </script>
</body>
</html>